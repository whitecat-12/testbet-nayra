<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Nayra - AI Pintar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* CSS Styles remain the same */
  </style>
</head>
<body>

<video id="idle" autoplay muted loop playsinline>
  <source src="media/idle.mp4" type="video/mp4" />
</video>

<video id="avatar" muted loop playsinline>
  <source src="media/avatar.mp4" type="video/mp4" />
</video>

<video id="joget" muted playsinline>
  <source src="media/joget.mp4" type="video/mp4" />
</video>

<div class="overlay">
  <button id="micButton" class="mic-button">
    <i class="fas fa-microphone"></i>
    Bicara
  </button>
  <button id="cancelButton" class="mic-button cancel-button">
    <i class="fas fa-times"></i>
    Batal
  </button>
</div>

<script>
const GROQ_API_KEY = "Bearer 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";
const idle = document.getElementById("idle");
const avatar = document.getElementById("avatar");
const joget = document.getElementById("joget");

let recognition = null;
let ucap = null;

async function mulaiRekam() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Perangkat tidak mendukung speech recognition.");
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = 'id-ID';
  recognition.interimResults = false;

  recognition.onresult = async function(event) {
    const teks = event.results[0][0].transcript;
    recognition.stop(); 
    recognition = null;

    const jawaban = await tanyaAI(teks);
    bicara(jawaban);
  };

  recognition.onerror = function(event) {
    console.error("Error:", event.error);
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
  };

  recognition.start();
}

async function tanyaAI(teks) {
  try {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": GROQ_API_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "llama3-8b-8192",
        messages: [
          {
            role: "system",
            content: "Kamu adalah Nayra AI, asisten pintar yang dikembangkan oleh teta.edu. Jawablah dengan ramah, sopan, dan mudah dimengerti oleh pengguna dari Indonesia."
          },
          {
            role: "user",
            content: teks
          }
        ],
        temperature: 0.7
      })
    });

    const data = await res.json();
    if (data.error) return "⚠️ Error: " + data.error.message;
    return data.choices?.[0]?.message?.content || "Maaf, tidak ada jawaban.";
  } catch (e) {
    console.error("Gagal fetch:", e);
    return "⚠️ Gagal menghubungi AI.";
  }
}

function bicara(teks) {
  const isJoget = /joget|menari|goyang/i.test(teks);
  const videoTarget = isJoget ? joget : avatar;

  // Menyembunyikan semua video terlebih dahulu
  idle.style.display = 'none';
  avatar.style.display = 'none';
  joget.style.display = 'none';

  // Mengecek jika ada video yang sedang diputar, hentikan dulu
  if (videoTarget && !videoTarget.paused) {
    videoTarget.pause();
  }

  // Menampilkan video target baru
  videoTarget.style.display = 'block';
  videoTarget.currentTime = 0;

  // Menunggu video selesai sebelum melanjutkan
  videoTarget.play().catch(err => {
    console.warn("Video gagal diputar:", err);
    videoTarget.style.display = 'none';
    idle.style.display = 'block';
  });

  // Event listener untuk video selesai diputar
  videoTarget.onended = () => {
    videoTarget.style.display = 'none';
    idle.style.display = 'block';
  };

  // Melakukan text-to-speech setelah video dimulai
  ucap = new SpeechSynthesisUtterance(teks);
  ucap.lang = "id-ID";
  speechSynthesis.speak(ucap);

  ucap.onend = () => {
    videoTarget.pause();
    videoTarget.style.display = 'none';
    idle.style.display = 'block';
    ucap = null;
  };
}


  ucap = new SpeechSynthesisUtterance(teks);
  ucap.lang = "id-ID";
  speechSynthesis.speak(ucap);

  ucap.onend = () => {
    if (videoTarget) {
      videoTarget.pause();
      videoTarget.style.display = 'none';
    }
    idle.style.display = 'block';
    ucap = null;
  };
}

function cancelSemua() {
  if (recognition) recognition.abort();
  if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();
  avatar.pause();
  avatar.style.display = 'none';
  idle.style.display = 'block';
}

document.getElementById("micButton").onclick = mulaiRekam;
document.getElementById("cancelButton").onclick = cancelSemua;
</script>

</body>
</html>
