<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nayra AI Chat</title>

  <!-- Font Awesome -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous" />

  <style>
    body {
      margin: 0;
      background-color: #1e1e1e;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .top-bar {
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      background-color: #1e1e1e;
      border-bottom: 1px solid #333;
    }

    .top-bar button {
      background-color: #3f3f3f;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      text-align: center;
      padding: 1rem;
    }

    .input-bar {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #2b2b2b;
      border-top: 1px solid #444;
    }

    .input-container {
      display: flex;
      align-items: center;
      background-color: #1e1e1e;
      border-radius: 20px;
      flex: 1;
      padding: 8px 12px;
      margin-right: 10px;
    }

    .input-container i {
      margin-right: 8px;
      color: #ccc;
    }

    .input-container input {
      background: transparent;
      border: none;
      outline: none;
      color: white;
      flex: 1;
    }

    .send-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: white;
      cursor: pointer;
    }

    .btns {
      position: absolute;
      top: 55px;
      right: 10px;
      display: flex;
      gap: 8px;
    }

    .btns button {
      background-color: #444;
      border: none;
      border-radius: 10px;
      padding: 4px 8px;
      font-size: 12px;
      color: white;
      cursor: pointer;
    }

    video {
      display: none;
    }

    .show {
      display: block !important;
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="top-bar">
    <i class="fas fa-bars"></i>
    <button><i class="fas fa-star"></i> Get Plus</button>
    <i class="fas fa-rotate-right"></i>
  </div>

  <!-- Tombol tambahan -->
  <div class="btns">
    <button id="micButton"><i class="fas fa-microphone"></i></button>
    <button id="cancelButton"><i class="fas fa-stop"></i></button>
    <button id="resetButton"><i class="fas fa-refresh"></i></button>
  </div>

  <!-- Konten utama -->
  <div class="main">
    Ready when you are.
  </div>

  <!-- Input bar -->
  <div class="input-bar">
    <div class="input-container">
      <i class="fas fa-plus"></i>
      <span style="margin-right: 10px; font-size: 14px;">Tools</span>
      <input type="text" placeholder="Ask anything" />
    </div>
    <button class="send-btn"><i class="fas fa-paper-plane"></i></button>
  </div>

  <!-- Video Placeholder -->
  <video id="idle" class="show" src=""></video>
  <video id="avatar" src=""></video>
  <video id="dance" src=""></video>

  <script>
    const GROQ_KEYS = [
      "Bearer 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",
      "Bearer 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"
    ];

    const idle = document.getElementById("idle");
    const avatar = document.getElementById("avatar");
    const dance = document.getElementById("dance");

    let recognition = null;
    let ucap = null;
    let history = ambilRiwayat();

    function getNamaPengguna() {
      return localStorage.getItem("namaPengguna") || null;
    }

    function setNamaPengguna(nama) {
      localStorage.setItem("namaPengguna", nama);
    }

    function simpanRiwayat() {
      localStorage.setItem("riwayatChat", JSON.stringify(history));
    }

    function ambilRiwayat() {
      const data = localStorage.getItem("riwayatChat");
      return data ? JSON.parse(data) : [];
    }

    function hapusRiwayat() {
      localStorage.removeItem("riwayatChat");
      history = [];
    }

    function show(video) {
      idle.classList.remove("show");
      avatar.classList.remove("show");
      dance.classList.remove("show");
      video.classList.add("show");
    }

    function bersihkanMarkdown(teks) {
      return teks.replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*(.*?)\*/g, '$1');
    }

    async function mulaiRekam() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Perangkat tidak mendukung speech recognition.");
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = 'id-ID';
      recognition.interimResults = false;

      recognition.onresult = async function(event) {
        const teks = event.results[0][0].transcript.trim();
        recognition.stop();
        recognition = null;

        if (/dance|nari|menari/i.test(teks)) {
          mulaiDance();
          return;
        }

        const regexNama = /nama(?:ku| saya)?(?: adalah)? ([a-zA-Z]+)/i;
        const match = teks.match(regexNama);
        if (match) {
          const nama = match[1];
          setNamaPengguna(nama);
          bicara(`Hai ${nama}, senang bertemu denganmu!`);
          return;
        }

        const jawaban = await tanyaAI(teks);
        bicara(bersihkanMarkdown(jawaban));
      };

      recognition.onerror = function(event) {
        console.error("Error:", event.error);
        recognition.stop();
        recognition = null;
      };

      recognition.start();
    }

    async function cobaGroqDenganBanyakKey(body) {
      for (const key of GROQ_KEYS) {
        try {
          const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
              "Authorization": key,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
          });

          if (!res.ok) {
            const err = await res.json();
            console.warn("Gagal dengan key:", key, err.error?.message);
            continue;
          }

          return await res.json();
        } catch (err) {
          console.error("Fetch error:", err);
        }
      }

      return { error: { message: "Semua API gagal dihubungi." } };
    }

    async function tanyaAI(teks) {
      const nama = getNamaPengguna();
      const systemPrompt = `Kamu adalah Nayra AI, asisten pintar dari teta.education. ${nama ? `Nama pengguna adalah ${nama}.` : ""} Kamu memiliki tubuh virtual yang dapat dilihat oleh pengguna dalam bentuk 3d model. Kamu bisa berbicara, menari, dan melakukan gerakan tertentu. Jawablah dengan ramah, sopan, dan mudah dimengerti oleh pengguna dari Indonesia.`;

      history.push({ role: "user", content: teks });

      const body = {
        model: "llama3-8b-8192",
        messages: [{ role: "system", content: systemPrompt }, ...history],
        temperature: 0.7
      };

      const data = await cobaGroqDenganBanyakKey(body);

      if (data.error) {
        return "⚠️ Error: " + data.error.message;
      }

      const reply = data.choices?.[0]?.message?.content || "Maaf, tidak ada jawaban.";
      history.push({ role: "assistant", content: reply });
      simpanRiwayat();

      return reply;
    }

    function mulaiDance() {
      show(dance);
      dance.currentTime = 0;
      dance.play().catch(err => console.warn("Video dance gagal:", err));
      dance.onended = () => show(idle);
    }

    function bicara(teks) {
      show(avatar);
      avatar.currentTime = 0;
      avatar.play().catch(err => console.warn("Video gagal:", err));

      ucap = new SpeechSynthesisUtterance(teks);
      ucap.lang = "id-ID";
      speechSynthesis.speak(ucap);

      ucap.onend = () => {
        avatar.pause();
        show(idle);
        ucap = null;
      };
    }

    function cancelSemua() {
      if (recognition) recognition.abort();
      if (speechSynthesis.speaking || speechSynthesis.pending) speechSynthesis.cancel();

      idle.pause(); avatar.pause(); dance.pause();
      show(idle);
      idle.currentTime = 0;
      idle.play().catch(err => console.warn("Idle gagal jalan:", err));
    }

    function resetKonteks() {
      hapusRiwayat();
      bicara("Konteks telah dihapus. Kita bisa mulai percakapan baru.");
    }

    // Tombol kontrol
    document.getElementById("micButton").onclick = mulaiRekam;
    document.getElementById("cancelButton").onclick = cancelSemua;
    document.getElementById("resetButton").onclick = resetKonteks;
  </script>
</body>
</html>
